<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>Load Balancer App - –ö–µ—Ä—É–≤–∞–Ω–Ω—è –ó–∞–¥–∞—á–∞–º–∏</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; }
        h2 { border-bottom: 2px solid #ccc; padding-bottom: 5px; }
        .container { margin-bottom: 20px; padding: 15px; border: 1px solid #eee; border-radius: 5px; }
        button, input { padding: 10px; margin: 5px 0; border-radius: 4px; border: 1px solid #ccc; }
        .task-item { border-bottom: 1px dashed #ddd; padding: 10px 0; }
        .progress-bar { height: 10px; background-color: #f3f3f3; border-radius: 5px; margin-top: 5px; }
        .progress-fill { height: 100%; background-color: #4CAF50; border-radius: 5px; transition: width 0.3s; }
        .error { color: red; }
        .success { color: green; }
    </style>
    <script src="http://localhost/socket.io/socket.io.js"></script> 
</head>
<body>

    <h1>üöÄ –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è –ë–∞–ª–∞–Ω—Å—É–≤–∞–Ω–Ω—è –ù–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</h1>

    <div class="container" id="auth-section">
        <h2>üîë –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è</h2>
        <input type="text" id="username" placeholder="–Ü–º'—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ (–Ω–∞–ø—Ä. user1)">
        <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å">
        <button onclick="registerUser()">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</button>
        <button onclick="loginUser()">–£–≤—ñ–π—Ç–∏</button>
        <p id="auth-message"></p>
    </div>

    <div id="app-section" style="display:none;">

        <p>–ü—ñ–¥–∫–ª—é—á–µ–Ω–æ —è–∫: <strong id="current-user"></strong> | <span id="socket-status" class="error">Socket.IO: –í—ñ–¥–∫–ª—é—á–µ–Ω–æ</span></p>

        <div class="container">
            <h2>‚öôÔ∏è –ó–∞–ø—É—Å—Ç–∏—Ç–∏ –ù–æ–≤—É –ó–∞–¥–∞—á—É</h2>
            <input type="number" id="iterations" placeholder="–ö—ñ–ª—å–∫—ñ—Å—Ç—å –Ü—Ç–µ—Ä–∞—Ü—ñ–π (–ù–∞–ø—Ä–∏–∫–ª–∞–¥, 10000000000)" value="10000000000" min="1000">
            <button onclick="submitTask()">–ó–∞–ø—É—Å—Ç–∏—Ç–∏ –¢—Ä—É–¥–æ–º—ñ—Å—Ç–∫—É –ó–∞–¥–∞—á—É</button>
            <p id="task-message"></p>
        </div>

        <div class="container">
            <h2>üìú –Ü—Å—Ç–æ—Ä—ñ—è —Ç–∞ –ü–æ—Ç–æ—á–Ω–∏–π –°—Ç–∞–Ω –ó–∞–¥–∞—á (–ü—É–Ω–∫—Ç 3)</h2>
            <button onclick="fetchTasks()">–û–Ω–æ–≤–∏—Ç–∏ –Ü—Å—Ç–æ—Ä—ñ—é</button>
            <div id="task-list"></div>
        </div>
    </div>

    <script>
        const NGINX_URL = 'http://localhost'; // –£—Å—ñ –∑–∞–ø–∏—Ç–∏ –π–¥—É—Ç—å –Ω–∞ Nginx (–ø–æ—Ä—Ç 80)
        let userToken = localStorage.getItem('accessToken') || '';
        let currentUserId = localStorage.getItem('userId') || null;
        let currentUsername = localStorage.getItem('username') || '';
        let socket = null;

        // --- –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Å—Ç–∞–Ω–æ–º UI ---

        function updateUI() {
            if (userToken) {
                document.getElementById('auth-section').style.display = 'none';
                document.getElementById('app-section').style.display = 'block';
                document.getElementById('current-user').textContent = currentUsername || 'N/A';
                connectSocket(userToken);
                fetchTasks();
            } else {
                document.getElementById('auth-section').style.display = 'block';
                document.getElementById('app-section').style.display = 'none';
                if (socket) socket.disconnect();
            }
        }

        // --- 1. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è (–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è/–õ–æ–≥—ñ–Ω) ---

        async function authRequest(endpoint, username, password) {
            const response = await fetch(`${NGINX_URL}/${endpoint}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });
            const data = await response.json();
            const msgEl = document.getElementById('auth-message');
            msgEl.className = response.ok ? 'success' : 'error';

            if (response.ok) {
                userToken = data.accessToken;
                currentUserId = data.userId;
                currentUsername = username;
                localStorage.setItem('accessToken', userToken);
                localStorage.setItem('userId', currentUserId);
                localStorage.setItem('username', currentUsername);
                msgEl.textContent = `–£—Å–ø—ñ—Ö! –í—ñ—Ç–∞—î–º–æ, ${username}.`;
                updateUI();
            } else {
                msgEl.textContent = data.message || `–ü–æ–º–∏–ª–∫–∞: ${response.statusText}`;
            }
        }

        function registerUser() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            authRequest('register', username, password);
        }

        function loginUser() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            authRequest('login', username, password);
        }

        // --- 2. Socket.IO (–ü—Ä–æ–≥—Ä–µ—Å –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ) ---

        function connectSocket(token) {
            if (socket && socket.connected) return;

            socket = io(NGINX_URL, {
                auth: { token: token },
                reconnectionAttempts: 5,
            });

            const statusEl = document.getElementById('socket-status');

            socket.on('connect', () => {
                statusEl.textContent = 'Socket.IO: –ü—ñ–¥–∫–ª—é—á–µ–Ω–æ';
                statusEl.className = 'success';
            });

            socket.on('connect_error', (error) => {
                statusEl.textContent = `Socket.IO: –ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è (${error.message})`;
                statusEl.className = 'error';
                console.error('Socket.IO Error:', error);
            });
            
            // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–æ–≥—Ä–µ—Å—É –≤—ñ–¥ Worker'—ñ–≤ —á–µ—Ä–µ–∑ Pub/Sub (–ü—É–Ω–∫—Ç 2)
            socket.on('task_update', (data) => {
                updateTaskDisplay(data);
            });
        }
        
        // --- 3. –ö–µ—Ä—É–≤–∞–Ω–Ω—è –ó–∞–¥–∞—á–∞–º–∏ (–ó–∞–ø—É—Å–∫, –Ü—Å—Ç–æ—Ä—ñ—è, –°–∫–∞—Å—É–≤–∞–Ω–Ω—è) ---
        
        async function submitTask() {
            const iterations = parseInt(document.getElementById('iterations').value);
            const msgEl = document.getElementById('task-message');
            msgEl.textContent = '';

            if (isNaN(iterations) || iterations < 1000) {
                msgEl.className = 'error';
                msgEl.textContent = '–ö—ñ–ª—å–∫—ñ—Å—Ç—å —ñ—Ç–µ—Ä–∞—Ü—ñ–π –º–∞—î –±—É—Ç–∏ > 1000.';
                return;
            }

            const response = await fetch(NGINX_URL + '/api/tasks', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${userToken}`
                },
                body: JSON.stringify({ taskParams: { iterations } })
            });

            const result = await response.json();
            msgEl.className = response.ok ? 'success' : 'error';
            msgEl.textContent = result.message || JSON.stringify(result);
            
            if (result.taskId) {
                // –î–æ–¥–∞—î–º–æ –Ω–æ–≤—É –∑–∞–¥–∞—á—É –¥–æ —Å–ø–∏—Å–∫—É —ñ –ø–æ—á–∏–Ω–∞—î–º–æ —ó—ó –≤—ñ–¥—Å—Ç–µ–∂—É–≤–∞—Ç–∏
                fetchTasks(); 
            }
        }

        async function fetchTasks() {
            const response = await fetch(NGINX_URL + '/api/tasks', {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${userToken}` }
            });

            if (!response.ok) {
                document.getElementById('task-list').innerHTML = `<p class="error">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó: ${response.statusText}</p>`;
                return;
            }

            const tasks = await response.json();
            const listEl = document.getElementById('task-list');
            listEl.innerHTML = '';
            
            tasks.forEach(task => {
                const taskEl = document.createElement('div');
                taskEl.className = 'task-item';
                taskEl.id = `task-${task.job_id}`;
                taskEl.innerHTML = renderTaskItem(task);
                listEl.appendChild(taskEl);
            });
        }
        
        async function cancelTask(jobId) {
            const response = await fetch(`${NGINX_URL}/api/tasks/${jobId}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${userToken}` }
            });
            
            if (response.ok) {
                alert(`–ó–∞–¥–∞—á–∞ ${jobId} –≤—ñ–¥–º—ñ–Ω–µ–Ω–∞. –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É –æ—á—ñ–∫—É—î—Ç—å—Å—è.`);
                // –°—Ç–∞—Ç—É—Å –±—É–¥–µ –æ–Ω–æ–≤–ª–µ–Ω–æ —á–µ—Ä–µ–∑ WebSocket
            } else {
                alert(`–ü–æ–º–∏–ª–∫–∞ —Å–∫–∞—Å—É–≤–∞–Ω–Ω—è: ${response.statusText}`);
            }
        }

        function updateTaskDisplay(data) {
            const taskEl = document.getElementById(`task-${data.taskId}`);
            if (taskEl) {
                // –û–Ω–æ–≤–ª—é—î–º–æ –ª–∏—à–µ —Å—Ç–∞—Ç—É—Å —ñ –ø—Ä–æ–≥—Ä–µ—Å
                taskEl.querySelector('.task-status-text').textContent = data.status;
                taskEl.querySelector('.progress-fill').style.width = `${data.progress}%`;
                taskEl.querySelector('.progress-percent').textContent = `${data.progress}%`;
            } else {
                // –Ø–∫—â–æ –∑–∞–¥–∞—á–∞ —â–µ –Ω–µ –≤ —ñ—Å—Ç–æ—Ä—ñ—ó, –∞–ª–µ –ø—Ä–∏–π—à–ª–æ –ø–µ—Ä—à–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è, –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —ñ—Å—Ç–æ—Ä—ñ—é
                fetchTasks();
            }
        }
        
        // --- –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –µ–ª–µ–º–µ–Ω—Ç–∞ –∑–∞–¥–∞—á—ñ ---
        
        function renderTaskItem(task) {
            const statusColor = task.status === 'COMPLETED' ? 'green' : (task.status === 'RUNNING' ? 'blue' : (task.status === 'ERROR' ? 'red' : 'gray'));
            const cancelBtn = (task.status === 'RUNNING' || task.status === 'PENDING') 
                              ? `<button onclick="cancelTask('${task.job_id}')">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>` 
                              : '';
                              
            return `
                <div>
                    <strong>ID: ${task.job_id}</strong> (PG ID: ${task.id}) - –°—Ç–≤–æ—Ä–µ–Ω–æ: ${new Date(task.created_at).toLocaleTimeString()}
                    <br>
                    –ü–∞—Ä–∞–º–µ—Ç—Ä–∏: ${JSON.stringify(task.params)}
                    <br>
                    –°—Ç–∞—Ç—É—Å: <span class="task-status-text" style="color: ${statusColor};">${task.status}</span>
                    <span class="progress-percent">${task.progress}%</span>
                    ${cancelBtn}
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${task.progress}%;"></div>
                </div>
                ${task.result ? `<p class="success">–†–µ–∑—É–ª—å—Ç–∞—Ç: ${JSON.stringify(task.result)}</p>` : ''}
            `;
        }

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
        document.addEventListener('DOMContentLoaded', updateUI);
    </script>

</body>
</html>